<?xml version="1.0" encoding="UTF-8"?>
<configuration>

  <system.webServer>

    <!-- =====================================================================
         Authentication — IIS Windows Authentication (AD passthrough)
         Requires the "Windows Authentication" IIS feature to be installed.
         install.ps1 enables this automatically.
    ===================================================================== -->
    <security>
      <authentication>
        <anonymousAuthentication enabled="false" />
        <windowsAuthentication enabled="true" />
      </authentication>
    </security>

    <!-- =====================================================================
         URL Rewrite — requires the IIS URL Rewrite module (free, from Microsoft).
         install.ps1 installs it automatically via Web Platform Installer or direct download.
         Remove this section if you cannot install the module — the app will still
         work when accessed via explicit file paths (index.php, admin/index.php, etc.).
    ===================================================================== -->
    <rewrite>
      <rules>
        <!-- Redirect bare root to index.php -->
        <rule name="Root to index" stopProcessing="true">
          <match url="^$" />
          <action type="Rewrite" url="index.php" />
        </rule>
        <!-- Don't rewrite real files or directories (css, js, uploads, etc.) -->
        <rule name="Skip existing files" stopProcessing="true">
          <match url="." ignoreCase="false" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>
        <rule name="Skip existing directories" stopProcessing="true">
          <match url="." ignoreCase="false" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" />
          </conditions>
          <action type="None" />
        </rule>
      </rules>
    </rewrite>

    <!-- =====================================================================
         PHP FastCGI handler — tells IIS to process .php files via PHP.
         The path must match where install.ps1 installed PHP.
         If you used the Web Platform Installer or PHP Manager for IIS,
         this is configured automatically and you can remove this section.
    ===================================================================== -->
    <handlers>
      <remove name="PHP_via_FastCGI" />
      <add name="PHP_via_FastCGI"
           path="*.php"
           verb="GET,HEAD,POST"
           modules="FastCgiModule"
           scriptProcessor="C:\PHP\php-cgi.exe"
           resourceType="Either"
           requireAccess="Script" />
    </handlers>

    <!-- =====================================================================
         Default documents — IIS will serve index.php for directory requests.
    ===================================================================== -->
    <defaultDocument>
      <files>
        <clear />
        <add value="index.php" />
      </files>
    </defaultDocument>

    <!-- =====================================================================
         Block direct access to sensitive files.
    ===================================================================== -->
    <httpErrors errorMode="DetailedLocalOnly" />

  </system.webServer>

  <!-- Block access to config.php from the web (it lives one level above app/ anyway) -->
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <security>
        <requestFiltering>
          <hiddenSegments>
            <add segment="config.php" />
          </hiddenSegments>
        </requestFiltering>
      </security>
    </system.webServer>
  </location>

</configuration>
